rules:
- id: vm2-code-injection
  patterns:
  - pattern-inside: |
      ...
      require('vm2');
      ...
  - pattern-not-inside: |
      ...
      $CODE = "...";
      ...
  - pattern-not-inside: |
      ...
      $CODE = new VMScript(...);
      ...
  - pattern-either:
    - pattern: |
        $VM = new VM(...);
        ...
        $VM.run($CODE,...);
    - pattern: |
        new VM(...).run($CODE,...);
    - pattern: |
        $VM = new NodeVM(...);
        ...
        $VM.run($CODE,...);
    - pattern: |
        new NodeVM(...).run($CODE,...);
    - pattern: |
        new VMScript($CODE,...);
  - pattern-not: |
      $VM = new NodeVM(...);
      ...
      $VM.run("...",...);
  - pattern-not: |
      new VM(...).run("...",...);
  - pattern-not: |
      $VM = new NodeVM(...);
      ...
      $VM.run("...",...);
  - pattern-not: |
      new NodeVM(...).run("...",...);
  - pattern-not: new VMScript("...",...);
  message: |
    Make sure that unverified user data can not reach `vm2`.
  languages:
  - javascript
  severity: WARNING
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
